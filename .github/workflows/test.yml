name: Self Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run fake smoke test
        run: |
          python main.py --fake --smoke-test

      - name: Run short fake loop
        run: |
          python main.py --fake-run 3

      - name: CSV integrity check
        run: |
          python - <<'PY'
          import csv
          from pathlib import Path

          path = Path("obd_readings.csv")
          checks = []

          def record(ok: bool, message: str) -> bool:
              icon = "✅" if ok else "❌"
              print(f"[CI] {message} {icon}")
              checks.append((ok, message))
              return ok

          exists = record(path.exists(), "CSV file exists")
          if exists:
              with path.open(newline="", encoding="utf-8") as handle:
                  rows = list(csv.reader(handle))

              record(bool(rows), "CSV contains rows")
              header_present = bool(rows[0]) if rows else False
              record(header_present, "CSV header present")

              row_count = len(rows) - 1 if rows else 0
              meets_threshold = row_count >= 3
              record(meets_threshold, "Row count >= 3")
          else:
              record(False, "CSV header present")
              record(False, "Row count >= 3")

          print("\n[CI] CSV summary:")
          for ok, message in checks:
              status = "PASS" if ok else "FAIL"
              icon = "✅" if ok else "❌"
              print(f"[CI] {status}: {message} {icon}")

          if not all(ok for ok, _ in checks):
              raise SystemExit(1)
          PY

      - name: Graceful shutdown simulation
        run: |
          python - <<'PY'
          import subprocess
          import sys

          checks = []

          def record(ok: bool, message: str) -> None:
              icon = "✅" if ok else "❌"
              status = "PASS" if ok else "FAIL"
              print(f"[CI] {message} {icon}")
              checks.append((status, message, icon))

          cmd = [sys.executable, "main.py", "--fake-run", "5", "--debug"]
          proc = subprocess.run(cmd, capture_output=True, text=True)
          print(proc.stdout, end="")
          if proc.stderr:
              print(proc.stderr, file=sys.stderr, end="")

          record(proc.returncode == 0, "Graceful exit")
          shutdown_logged = "===== Shutdown complete =====" in proc.stdout
          record(shutdown_logged, "Shutdown banner printed")

          print("\n[CI] Run summary:")
          for status, message, icon in checks:
              print(f"[CI] {status}: {message} {icon}")

          if proc.returncode != 0 or not shutdown_logged:
              raise SystemExit(1)
          PY

      - name: Text dashboard checks
        run: |
          python - <<'PY'
          import contextlib
          import io
          from unittest import mock

          import text_dashboard

          checks: list[tuple[bool, str]] = []

          def record(ok: bool, message: str) -> None:
              icon = "✅" if ok else "❌"
              status = "PASS" if ok else "FAIL"
              print(f"[CI] {status}: {message} {icon}")
              checks.append((ok, message))

          record(True, "text_dashboard imported")

          fake_reading = {
              "timestamp": "2024-01-01T00:00:00Z",
              "rpm": 2200,
              "vehicle_speed_mph": 42,
              "coolant_temp_f": 185,
              "throttle_position_pct": 37,
          }

          loop_buffer = io.StringIO()
          with mock.patch("text_dashboard.get_latest_reading", return_value=fake_reading), mock.patch(
              "text_dashboard.time.sleep", return_value=None
          ), contextlib.redirect_stdout(loop_buffer):
              text_dashboard.run_dashboard(iterations=1)

          loop_output = loop_buffer.getvalue()
          for snippet in ["RPM", "Speed mph", "Coolant F", "Throttle", "Source: CSV"]:
              record(snippet in loop_output, f"output contains '{snippet}'")

          fallback_buffer = io.StringIO()
          with mock.patch("text_dashboard.get_latest_reading", side_effect=RuntimeError("no data")), mock.patch(
              "text_dashboard.generate_fake_reading", return_value=fake_reading
          ), mock.patch("text_dashboard.time.sleep", side_effect=KeyboardInterrupt), contextlib.redirect_stdout(
              fallback_buffer
          ):
              text_dashboard.run_dashboard(iterations=2)

          fallback_output = fallback_buffer.getvalue()
          record("Source: Simulated" in fallback_output, "fallback mode reported")
          record("Stopping dashboard" in fallback_output, "KeyboardInterrupt handled")

          failures = [message for ok, message in checks if not ok]
          if failures:
              raise SystemExit("; ".join(failures))
          PY

      - name: Final CI summary
        if: success()
        run: |
          echo ""
          echo "[CI] Overall summary:"
          echo "[CI] CSV validation ✅"
          echo "[CI] Graceful shutdown ✅"
