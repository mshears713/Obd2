name: Self Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run fake smoke test
        run: |
          python main.py --fake --smoke-test

      - name: Run short fake loop
        run: |
          python main.py --fake-run 3

      - name: CSV integrity check
        run: |
          python - <<'PY'
          import csv
          from pathlib import Path

          path = Path("obd_readings.csv")
          checks = []

          def record(ok: bool, message: str) -> bool:
              icon = "✅" if ok else "❌"
              print(f"[CI] {message} {icon}")
              checks.append((ok, message))
              return ok

          exists = record(path.exists(), "CSV file exists")
          if exists:
              with path.open(newline="", encoding="utf-8") as handle:
                  rows = list(csv.reader(handle))

              record(bool(rows), "CSV contains rows")
              header_present = bool(rows[0]) if rows else False
              record(header_present, "CSV header present")

              row_count = len(rows) - 1 if rows else 0
              meets_threshold = row_count >= 3
              record(meets_threshold, "Row count >= 3")
          else:
              record(False, "CSV header present")
              record(False, "Row count >= 3")

          print("\n[CI] CSV summary:")
          for ok, message in checks:
              status = "PASS" if ok else "FAIL"
              icon = "✅" if ok else "❌"
              print(f"[CI] {status}: {message} {icon}")

          if not all(ok for ok, _ in checks):
              raise SystemExit(1)
          PY

      - name: Graceful shutdown simulation
        run: |
          python - <<'PY'
          import subprocess
          import sys

          checks = []

          def record(ok: bool, message: str) -> None:
              icon = "✅" if ok else "❌"
              status = "PASS" if ok else "FAIL"
              print(f"[CI] {message} {icon}")
              checks.append((status, message, icon))

          cmd = [sys.executable, "main.py", "--fake-run", "5", "--debug"]
          proc = subprocess.run(cmd, capture_output=True, text=True)
          print(proc.stdout, end="")
          if proc.stderr:
              print(proc.stderr, file=sys.stderr, end="")

          record(proc.returncode == 0, "Graceful exit")
          shutdown_logged = "===== Shutdown complete =====" in proc.stdout
          record(shutdown_logged, "Shutdown banner printed")

          print("\n[CI] Run summary:")
          for status, message, icon in checks:
              print(f"[CI] {status}: {message} {icon}")

          if proc.returncode != 0 or not shutdown_logged:
              raise SystemExit(1)
          PY

      - name: Final CI summary
        if: success()
        run: |
          echo ""
          echo "[CI] Overall summary:"
          echo "[CI] CSV validation ✅"
          echo "[CI] Graceful shutdown ✅"
